<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åƒç¼–è¾‘å·¥å…· - A4åˆæˆæ‰“å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .upload-section {
            flex: 1;
            min-width: 300px;
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8e9ff;
            transform: scale(1.02);
        }

        .upload-info {
            font-size: 16px;
            color: #555;
        }

        .upload-hint {
            font-size: 14px;
            color: #888;
        }

        #fileInput {
            display: none;
        }

        .preview-section {
            margin-top: 30px;
            display: none;
        }

        .preview-section.show {
            display: block;
        }

        .preview-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            background: #f5f5f5;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: relative;
            z-index: 1;
        }

        .image-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 12px;
        }

        .image-controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 8px 5px;
            z-index: 10;
        }

        .zoom-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .zoom-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.15);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .scale-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .progress-section {
            margin-top: 20px;
            display: none;
        }

        .progress-section.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .result-section {
            margin-top: 30px;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-canvas {
            max-width: 100%;
            height: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* A4é¢„è§ˆåŒºåŸŸæ ·å¼ */
        .canvas-wrapper {
            position: relative;
            display: inline-block;
            margin: 0 auto;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        #previewCanvas {
            display: block;
            background: white;
        }

        #controlsOverlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .control-group {
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: auto;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-row {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .control-row.center-row {
            justify-content: center;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            color: #333;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .control-btn:hover {
            background: rgba(102, 126, 234, 0.7);
            color: white;
            transform: scale(1.1);
        }

        .control-btn.delete-btn {
            background: rgba(255, 100, 100, 0.4);
            color: white;
        }

        .control-btn.delete-btn:hover {
            background: rgba(255, 50, 50, 0.8);
        }

        .control-btn.reset-btn {
            font-size: 10px;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ å›¾åƒç¼–è¾‘å·¥å…· - A4åˆæˆæ‰“å°</h1>

        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <div class="header-section">
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ 11å¼ å›¾ç‰‡</div>
                <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼</div>
                <input type="file" id="fileInput" accept="image/*" multiple>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" id="clearBtn">æ¸…ç©º</button>
                <button class="btn btn-primary" id="downloadBtn" disabled>ğŸ“¥ ä¸‹è½½A4å›¾åƒ</button>
            </div>
        </div>

        <!-- A4é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-section" id="a4PreviewContainer">
            <div class="preview-title">A4æ‰“å°é¢„è§ˆ</div>
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="previewCanvas"></canvas>
                <div id="controlsOverlay"></div>
            </div>
        </div>

        <!-- å›¾ç‰‡åˆ—è¡¨åŒºåŸŸ -->
        <div class="preview-section" id="previewSection">
            <div class="preview-title">å·²é€‰æ‹©å›¾ç‰‡ (<span id="imageCount">0</span>/11)</div>
            <div class="image-grid" id="imageGrid"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" id="nextBtn">ä¸‹ä¸€ä¸ª</button>
                <button class="btn btn-secondary" id="clearBtn">æ¸…ç©º</button>
                <button class="btn btn-primary" id="generateBtn" disabled>ç”ŸæˆA4å›¾åƒ</button>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div class="result-section" id="resultSection">
            <div class="preview-title">ç”Ÿæˆç»“æœ</div>
            <canvas id="resultCanvas" class="result-canvas"></canvas>
            <div class="action-buttons">
                <button class="btn btn-primary" id="downloadBtn">ğŸ“¥ ä¸‹è½½å›¾åƒ</button>
            </div>
        </div>
    </div>

    <script>
        // A4çº¸å°ºå¯¸é…ç½® (300dpi)
        const A4_CONFIG = {
            widthMM: 210,
            heightMM: 297,
            dpi: 300,
            get pixelsPerMM() {
                return this.dpi / 25.4;  // æ¯æ¯«ç±³åƒç´ æ•°
            },
            get width() {
                return Math.round(this.widthMM * this.pixelsPerMM);
            },
            get height() {
                return Math.round(this.heightMM * this.pixelsPerMM);
            },
            get centerX() {
                return this.width / 2;
            },
            get centerY() {
                return this.height / 2;
            }
        };

        // å°å›¾åƒé…ç½®
        const IMAGE_CONFIG = {
            diameterMM: 70,    // åœ†å½¢ç›´å¾„ mm
            get diameterPx() {
                return Math.round(this.diameterMM * A4_CONFIG.pixelsPerMM);
            },
            get radius() {
                return this.diameterPx / 2;
            }
        };

        // 11ä¸ªåœ†å¿ƒä½ç½® (å•ä½: mm, æŒ‰ç…§ä»ä¸‹åˆ°ä¸Šã€ä»å·¦åˆ°å³çš„é¡ºåºæ’åˆ—)
        // åŸç‚¹åœ¨ä¸­å¿ƒï¼Œxè½´å‘å³ä¸ºæ­£ï¼Œyè½´å‘ä¸Šä¸ºæ­£
        const POSITIONS_MM = [
            { x: -68, y: -111 },   // 0: å·¦ä¸‹å¤–ä¾§
            { x: 68, y: -111 },    // 1: å³ä¸‹å¤–ä¾§
            { x: -68, y: -37 },    // 2: å·¦ä¸‹å†…ä¾§
            { x: 68, y: -37 },     // 3: å³ä¸‹å†…ä¾§
            { x: -68, y: 37 },     // 4: å·¦ä¸Šå†…ä¾§
            { x: 68, y: 37 },      // 5: å³ä¸Šå†…ä¾§
            { x: -68, y: 111 },    // 6: å·¦ä¸Šå¤–ä¾§
            { x: 68, y: 111 },     // 7: å³ä¸Šå¤–ä¾§
            { x: 0, y: 0 },        // 8: ä¸­å¿ƒ
            { x: 0, y: -74 },      // 9: ä¸­å¿ƒä¸‹
            { x: 0, y: 74 }        // 10: ä¸­å¿ƒä¸Š
        ];

        // å°†mmåæ ‡è½¬æ¢ä¸ºåƒç´ åæ ‡
        function mmToPixels(xMM, yMM, scale = 1) {
            const centerX = A4_CONFIG.centerX * scale;
            const centerY = A4_CONFIG.centerY * scale;
            const x = centerX + xMM * A4_CONFIG.pixelsPerMM * scale;
            const y = centerY - yMM * A4_CONFIG.pixelsPerMM * scale;
            return { x: Math.round(x), y: Math.round(y) };
        }

        // è·å–æ‰€æœ‰åœ†å¿ƒçš„åƒç´ åæ ‡
        const POSITIONS_PX = POSITIONS_MM.map(pos => mmToPixels(pos.x, pos.y, 1));

        // å…¨å±€å˜é‡
        let uploadedImages = [];
        let selectedIndex = -1;  // å½“å‰é€‰ä¸­çš„å›¾ç‰‡ç´¢å¼•ï¼Œ-1è¡¨ç¤ºæœªé€‰ä¸­

        // DOMå…ƒç´ 
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const imageCount = document.getElementById('imageCount');
        const clearBtn = document.getElementById('clearBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const generateBtn = document.getElementById('generateBtn');
        const nextBtn = document.getElementById('nextBtn');
        const a4PreviewContainer = document.getElementById('a4PreviewContainer');
        const previewCanvas = document.getElementById('previewCanvas');
        const controlsOverlay = document.getElementById('controlsOverlay');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const resultCanvas = document.getElementById('resultCanvas');
        const imageGrid = document.getElementById('imageGrid');
        const previewSection = document.getElementById('previewSection');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        const progressFill = document.getElementById('progressFill');
        const previewCtx = previewCanvas.getContext('2d');

        // äº‹ä»¶ç›‘å¬
        uploadSection.addEventListener('click', () => fileInput.click());
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        clearBtn.addEventListener('click', clearImages);
        generateBtn.addEventListener('click', generateA4Image);
        downloadBtn.addEventListener('click', downloadImage);
        nextBtn.addEventListener('click', selectNextImage);
        previewCanvas.addEventListener('click', handleCanvasClick);

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFiles(files) {
            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

            if (imageFiles.length === 0) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            const remainingSlots = 11 - uploadedImages.length;
            const filesToLoad = imageFiles.slice(0, remainingSlots);

            let loadedCount = 0;

            filesToLoad.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImages.push({
                            file: file,
                            element: img,
                            src: e.target.result,
                            scale: 1.0,
                            offsetX: 0,
                            offsetY: 0
                        });
                        loadedCount++;

                        imageCount.textContent = uploadedImages.length;

                        if (uploadedImages.length === 11) {
                            generateBtn.disabled = false;
                            downloadBtn.disabled = false;
                        }

                        renderPreview();
                        renderImageGrid();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
        function renderImageGrid() {
            imageGrid.innerHTML = '';

            uploadedImages.forEach((imgData, index) => {
                const item = document.createElement('div');
                item.className = 'image-item';

                const img = document.createElement('img');
                img.src = imgData.src;
                item.appendChild(img);

                const label = document.createElement('div');
                label.className = 'image-label';
                label.textContent = `#${index + 1}`;
                item.appendChild(label);

                imageGrid.appendChild(item);
            });

            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            previewSection.classList.add('show');
        }

        // æ›´æ–°é¢„è§ˆ
        function renderPreview() {
            const previewWidth = Math.round(A4_CONFIG.width * 0.25);
            const previewHeight = Math.round(A4_CONFIG.height * 0.25);

            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;

            // å¡«å……ç™½è‰²èƒŒæ™¯
            previewCtx.fillStyle = '#FFFFFF';
            previewCtx.fillRect(0, 0, previewWidth, previewHeight);

            // ç»˜åˆ¶æ‰€æœ‰å·²ä¸Šä¼ çš„å›¾ç‰‡
            uploadedImages.forEach((imgData, index) => {
                const pos = POSITIONS_PX[index];
                const radius = IMAGE_CONFIG.radius;

                // ç»˜åˆ¶åœ†å½¢èƒŒæ™¯
                previewCtx.beginPath();
                previewCtx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                previewCtx.fillStyle = '#f0f0f0';
                previewCtx.fill();
                previewCtx.strokeStyle = '#ddd';
                previewCtx.lineWidth = 1;
                previewCtx.stroke();
            });

            // ç»˜åˆ¶æ‰€æœ‰åœ†å½¢çš„æ·±è‰²å¤–è½®å»“çº¿
            POSITIONS_MM.forEach((posMM, index) => {
                const pos = mmToPixels(posMM.x, posMM.y, 1);
                const radius = IMAGE_CONFIG.radius;

                previewCtx.beginPath();
                previewCtx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                previewCtx.strokeStyle = '#333';
                previewCtx.lineWidth = 1;
                previewCtx.setLineDash([]);
                previewCtx.stroke();
            });

            // æ›´æ–°æ§åˆ¶æŒ‰é’®
            updateControls();

            // æ˜¾ç¤ºé¢„è§ˆ
            a4PreviewContainer.classList.add('show');
        }

        // æ›´æ–°æ§åˆ¶æŒ‰é’®
        function updateControls() {
            controlsOverlay.innerHTML = '';

            const previewWidth = previewCanvas.width;
            const previewHeight = previewCanvas.height;

            // æ›´æ–°overlayå°ºå¯¸
            controlsOverlay.style.width = previewWidth + 'px';
            controlsOverlay.style.height = previewHeight + 'px';

            POSITIONS_MM.forEach((posMM, index) => {
                const pos = mmToPixels(posMM.x, posMM.y, 1);
                const radius = IMAGE_CONFIG.radius;

                // åˆ›å»ºæ§åˆ¶ç»„
                const controlGroup = document.createElement('div');
                controlGroup.className = 'control-group';
                controlGroup.style.left = pos.x + 'px';
                controlGroup.style.top = pos.y + 'px';

                const imgData = uploadedImages[index];
                const offsetX = imgData ? imgData.offsetX * 1 : 0;
                const offsetY = imgData ? imgData.offsetY * 1 : 0;
                const controlX = pos.x + offsetX;
                const controlY = pos.y + offsetY;

                const hasImage = imgData !== undefined;
                const isSelected = selectedIndex === index;
                const scaleValue = hasImage ? (imgData.scale * 100).toFixed(0) + '%' : '-';

                controlGroup.innerHTML = `
                    <div class="scale-badge">${scaleValue}</div>
                    ${isSelected && hasImage ? `
                    <div class="control-buttons">
                        <button class="control-btn direction-btn" data-index="${index}" data-action="move-up" title="ä¸Šç§»">â†‘</button>
                        </div>
                        <div class="control-row center-row">
                            <button class="control-btn direction-btn" data-index="${index}" data-action="move-left" title="å·¦ç§»">â†</button>
                            <button class="control-btn" data-index="${index}" data-action="zoom-out" title="ç¼©å°">-</button>
                            <button class="control-btn reset-btn" data-index="${index}" data-action="reset" title="å¤åŸ">å¤åŸ</button>
                            <button class="control-btn" data-index="${index}" data-action="zoom-in" title="æ”¾å¤§">+</button>
                            <button class="control-btn direction-btn" data-index="${index}" data-action="move-right" title="å³ç§»">â†’</button>
                        </div>
                        <div class="control-row">
                            <button class="control-btn direction-btn" data-index="${index}" data-action="move-down" title="ä¸‹ç§»">â†“</button>
                        </div>
                        <div class="control-row"><button class="control-btn delete-btn" data-index="${index}" data-action="delete" title="åˆ é™¤">ğŸ—‘</button></div>
                    </div>
                    ` : ''}
                `;

                controlsOverlay.appendChild(controlGroup);
            });

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', handleControl);
            });
        }

        // å¤„ç†æ‰€æœ‰æ§åˆ¶æ“ä½œ
        function handleControl(e) {
            e.stopPropagation();
            const btn = e.target;
            const index = parseInt(btn.dataset.index);
            const action = btn.dataset.action;

            // åˆ é™¤æ“ä½œ
            if (action === 'delete') {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                    uploadedImages.splice(index, 1);
                    uploadCount.textContent = uploadedImages.length;
                    previewCount.textContent = uploadedImages.length;
                    downloadBtn.disabled = uploadedImages.length !== 11;

                    selectedIndex = -1;  // åˆ é™¤åå–æ¶ˆé€‰ä¸­
                    renderPreview();
                }
                return;
            }

            // å…¶ä»–æ“ä½œéœ€è¦å…ˆä¸Šä¼ å›¾ç‰‡
            if (!uploadedImages[index]) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            const imgData = uploadedImages[index];
            const zoomStep = 0.1;
            const moveStep = 10;  // æ¯æ¬¡ç§»åŠ¨10åƒç´ 

            if (action === 'zoom-in') {
                imgData.scale = Math.min(imgData.scale + zoomStep, 3.0);
            } else if (action === 'zoom-out') {
                imgData.scale = Math.max(imgData.scale - zoomStep, 0.3);
            } else if (action === 'reset') {
                imgData.scale = 1.0;
                imgData.offsetX = 0;
                imgData.offsetY = 0;
            } else if (action === 'move-up') {
                imgData.offsetY += moveStep;
            } else if (action === 'move-down') {
                imgData.offsetY -= moveStep;
            } else if (action === 'move-left') {
                imgData.offsetX -= moveStep;
            } else if (action === 'move-right') {
                imgData.offsetX += moveStep;
            }

            // é‡æ–°æ¸²æŸ“é¢„è§ˆ
            renderPreview();
        }

        // æ¸…ç©ºå›¾ç‰‡
        function clearImages() {
            uploadedImages = [];
            selectedIndex = -1;  // æ¸…ç©ºæ—¶å–æ¶ˆé€‰ä¸­
            imageCount.textContent = '0';
            generateBtn.disabled = true;
            downloadBtn.disabled = true;
            a4PreviewContainer.classList.remove('show');
            previewSection.classList.remove('show');
            fileInput.value = '';
            imageGrid.innerHTML = '';
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }

        // å¤„ç†canvasç‚¹å‡»
        function handleCanvasClick(e) {
            const rect = previewCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // æ£€æŸ¥ç‚¹å‡»äº†å“ªä¸ªåœ†å½¢
            POSITIONS_MM.forEach((posMM, index) => {
                if (index >= uploadedImages.length) return;

                const pos = mmToPixels(posMM.x, posMM.y, 0.25); // é¢„è§ˆç¼©æ”¾æ¯”ä¾‹
                const radius = IMAGE_CONFIG.radius * 0.25;

                const imgData = uploadedImages[index];
                if (!imgData) return;

                // è®¡ç®—è€ƒè™‘å›¾ç‰‡åç§»åçš„å®é™…åœ†å¿ƒä½ç½®
                const actualX = pos.x + imgData.offsetX * 0.25;
                const actualY = pos.y - imgData.offsetY * 0.25;

                const distance = Math.sqrt((x - actualX) ** 2 + (y - actualY) ** 2);

                if (distance <= radius) {
                    selectedIndex = index;
                    renderPreview();
                }
            });
        }

        // é€‰æ‹©ä¸‹ä¸€ä¸ªå›¾ç‰‡
        function selectNextImage() {
            if (uploadedImages.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            selectedIndex = (selectedIndex + 1) % uploadedImages.length;
            renderPreview();
        }

        // å°†å›¾ç‰‡è£å‰ªä¸ºåœ†å½¢å¹¶åº”ç”¨ç¼©æ”¾å’Œå¹³ç§»
        function processImageToCircle(img, scale = 1.0, offsetX = 0, offsetY = 0) {
            const size = IMAGE_CONFIG.diameterPx;
            const radius = IMAGE_CONFIG.radius;

            // åˆ›å»ºä¸´æ—¶canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size;
            tempCanvas.height = size;
            const tempCtx = tempCanvas.getContext('2d');

            // å¡«å……ç™½è‰²èƒŒæ™¯
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, size, size);

            // åˆ›å»ºåœ†å½¢è£å‰ªè·¯å¾„
            tempCtx.beginPath();
            tempCtx.arc(radius, radius, radius, 0, Math.PI * 2);
            tempCtx.clip();

            // è®¡ç®—å›¾ç‰‡ç¼©æ”¾å’Œä½ç½®ï¼ˆä¿æŒå®½é«˜æ¯”ï¼Œå¡«å……åœ†å½¢åŒºåŸŸï¼‰
            const imgSize = Math.max(img.width, img.height);
            const baseScale = (size * 2.5) / imgSize;
            const finalScale = baseScale * scale;
            const scaledWidth = img.width * finalScale;
            const scaledHeight = img.height * finalScale;
            const x = (size - scaledWidth) / 2 + offsetX;
            const y = (size - scaledHeight) / 2 + offsetY;

            // ç»˜åˆ¶å›¾ç‰‡
            tempCtx.drawImage(img, x, y, scaledWidth, scaledHeight);
            tempCtx.restore();

            return tempCanvas;
        }

        // ç”ŸæˆA4å›¾åƒ
        async function generateA4Image() {
            if (uploadedImages.length !== 11) {
                alert('è¯·ä¸Šä¼ 11å¼ å›¾ç‰‡ï¼');
                return;
            }

            progressSection.classList.add('show');
            resultSection.classList.remove('show');
            generateBtn.disabled = true;
            downloadBtn.disabled = true;

            // è®¾ç½®ç»“æœcanvaså°ºå¯¸
            resultCanvas.width = A4_CONFIG.width;
            resultCanvas.height = A4_CONFIG.height;
            const ctx = resultCanvas.getContext('2d');

            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, A4_CONFIG.width, A4_CONFIG.height);

            // æ›´æ–°è¿›åº¦
            progressFill.textContent = '10%';
            progressFill.style.width = '10%';
            await new Promise(resolve => setTimeout(resolve, 100));

            // ç»˜åˆ¶æ‰€æœ‰å›¾ç‰‡
            for (let i = 0; i < uploadedImages.length; i++) {
                const imgData = uploadedImages[i];
                const pos = POSITIONS_PX[i];
                const radius = IMAGE_CONFIG.radius;

                // åˆ›å»ºåœ†å½¢è£å‰ª
                ctx.save();
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                ctx.clip();

                const img = imgData.element;
                const imgSize = Math.max(img.width, img.height);
                const baseScale = (radius * 2.5) / imgSize;
                const finalScale = baseScale * imgData.scale;
                const scaledWidth = img.width * finalScale;
                const scaledHeight = img.height * finalScale;
                const x = pos.x - scaledWidth / 2;
                const y = pos.y - scaledHeight / 2;

                ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                ctx.restore();

                // æ›´æ–°è¿›åº¦
                const progress = Math.round((i + 1) / uploadedImages.length * 80) + 10;
                progressFill.textContent = progress + '%';
                progressFill.style.width = progress + '%';
            }

            // ç»˜åˆ¶æ‰€æœ‰åœ†å½¢çš„æ·±è‰²è½®å»“çº¿
            POSITIONS_MM.forEach((posMM, index) => {
                const pos = mmToPixels(posMM.x, posMM.y, 1);
                const radius = IMAGE_CONFIG.radius;

                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.setLineDash([]);
                ctx.stroke();
            });

            // æ›´æ–°è¿›åº¦å®Œæˆ
            progressFill.textContent = '100%';
            progressFill.style.width = '100%';

            // å®Œæˆåæ˜¾ç¤ºç»“æœ
            await new Promise(resolve => setTimeout(resolve, 300));

            progressSection.classList.remove('show');
            resultSection.classList.add('show');
            generateBtn.disabled = false;
            downloadBtn.disabled = false;

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // ä¸‹è½½å›¾åƒ
        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'A4åˆæˆå›¾åƒ_' + new Date().getTime() + '.png';
            link.href = resultCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
