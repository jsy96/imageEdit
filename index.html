<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åƒç¼–è¾‘å·¥å…· - A4åˆæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .upload-section {
            flex: 1;
            min-width: 300px;
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8e9ff;
            transform: scale(1.02);
        }

        .upload-info {
            font-size: 16px;
            color: #555;
            margin-bottom: 8px;
        }

        .upload-count {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }

        #fileInput {
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        /* A4é¢„è§ˆåŒºåŸŸ */
        .a4-preview-container {
            position: relative;
            margin-top: 30px;
            display: none;
        }

        .a4-preview-container.show {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-title {
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }

        .canvas-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            overflow-x: auto;
            cursor: pointer;
        }

        #previewCanvas {
            display: block;
            max-width: 100%;
            height: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        /* æ§åˆ¶æŒ‰é’®å®¹å™¨ */
        .controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .control-group {
            position: absolute;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .control-group:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .control-buttons {
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.2);
            padding: 6px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            flex-wrap: wrap;
            justify-content: center;
            max-width: 200px;
            backdrop-filter: blur(2px);
        }

        .control-btn {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .control-btn:hover {
            background: rgba(102, 126, 234, 0.8);
            color: white;
            transform: scale(1.15);
            text-shadow: none;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.reset-btn {
            width: auto;
            min-width: 40px;
            padding: 0 10px;
            border-radius: 12px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.4);
        }

        .control-btn.delete-btn {
            background: rgba(231, 76, 60, 0.5);
            color: white;
        }

        .control-btn.delete-btn:hover {
            background: rgba(231, 76, 60, 0.8);
        }

        .control-btn.direction-btn {
            font-size: 14px;
        }

        .scale-badge {
            background: rgba(102, 126, 234, 0.4);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .control-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .control-row.center-row {
            align-items: center;
        }

        .circle-indicator {
            position: absolute;
            border: 3px dashed #667eea;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.6;
        }

        /* éšè—çš„é«˜åˆ†è¾¨ç‡canvasç”¨äºä¸‹è½½ */
        #outputCanvas {
            display: none;
        }
        /* å“åº”å¼è®¾è®¡ - æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 12px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            .header-section {
                flex-direction: column;
                gap: 10px;
            }

            .upload-section {
                padding: 20px;
                min-width: auto;
            }

            .upload-info {
                font-size: 14px;
            }

            .action-buttons {
                width: 100%;
                justify-content: stretch;
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .preview-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .preview-title {
                font-size: 16px;
            }

            #previewCanvas {
                border-width: 1px;
            }

            .control-buttons {
                padding: 4px;
                border-radius: 12px;
                max-width: 100%;
            }

            .control-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .control-btn.reset-btn {
                min-width: 36px;
                padding: 0 8px;
                font-size: 11px;
            }

            .control-btn.direction-btn {
                font-size: 12px;
            }

            .scale-badge {
                font-size: 10px;
                padding: 3px 6px;
            }

            .control-row {
                gap: 3px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 18px;
            }

            .upload-info {
                font-size: 13px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .control-btn {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }

            .control-btn.reset-btn {
                min-width: 32px;
                padding: 0 6px;
                font-size: 10px;
            }

            .control-btn.direction-btn {
                font-size: 11px;
            }

            .scale-badge {
                font-size: 9px;
                padding: 2px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ å›¾åƒç¼–è¾‘å·¥å…· - A4åˆæˆæ‰“å°</h1>

        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <div class="header-section">
            <div class="upload-section" id="uploadSection">
                <div class="upload-info">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ 11å¼ å›¾ç‰‡</div>
                <div class="upload-count">å·²ä¸Šä¼ : <span id="uploadCount">0</span>/11</div>
                <input type="file" id="fileInput" accept="image/*" multiple>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" id="clearBtn">æ¸…ç©º</button>
                <button class="btn btn-primary" id="downloadBtn" disabled>ğŸ“¥ ä¸‹è½½A4å›¾åƒ</button>
            </div>
        </div>

        <!-- A4é¢„è§ˆåŒºåŸŸ -->
        <div class="a4-preview-container" id="a4PreviewContainer">
            <div class="preview-header">
                <div class="preview-title">A4æ‰“å°é¢„è§ˆ (300dpi) - ç‚¹å‡»åœ†å½¢é€‰ä¸­å›¾ç‰‡è¿›è¡Œç¼–è¾‘</div>
                <div class="upload-count">å›¾ç‰‡: <span id="previewCount">0</span>/11</div>
            </div>
            <div class="canvas-wrapper" id="canvasWrapper">
                <canvas id="previewCanvas"></canvas>
                <div class="controls-overlay" id="controlsOverlay"></div>
            </div>
        </div>

        <!-- éšè—çš„è¾“å‡ºcanvas -->
        <canvas id="outputCanvas"></canvas>
    </div>

    <script>
        // A4çº¸å°ºå¯¸é…ç½® (300dpi)
        const A4_CONFIG = {
            widthMM: 210,
            heightMM: 297,
            dpi: 300,
            get pixelsPerMM() {
                return this.dpi / 25.4;
            },
            get width() {
                return Math.round(this.widthMM * this.pixelsPerMM);
            },
            get height() {
                return Math.round(this.heightMM * this.pixelsPerMM);
            },
            get centerX() {
                return this.width / 2;
            },
            get centerY() {
                return this.height / 2;
            }
        };

        // å°å›¾åƒé…ç½®
        const IMAGE_CONFIG = {
            diameterMM: 70,
            get diameterPx() {
                return Math.round(this.diameterMM * A4_CONFIG.pixelsPerMM);
            },
            get radius() {
                return this.diameterPx / 2;
            }
        };

        // 11ä¸ªåœ†å¿ƒä½ç½® (å•ä½: mm)
        const POSITIONS_MM = [
            { x: 68, y: -111 },
            { x: 68, y: -37 },
            { x: 68, y: 111 },
            { x: 68, y: 37 },
            { x: -68, y: -111 },
            { x: -68, y: -37 },
            { x: -68, y: 111 },
            { x: -68, y: 37 },
            { x: 0, y: 0 },
            { x: 0, y: -74 },
            { x: 0, y: 74 }
        ];

        // é¢„è§ˆæ˜¾ç¤ºé…ç½®ï¼ˆç¼©å°æ˜¾ç¤ºä»¥æé«˜æ€§èƒ½ï¼‰
        const PREVIEW_SCALE = 0.25;

        // å°†mmåæ ‡è½¬æ¢ä¸ºåƒç´ åæ ‡
        function mmToPixels(xMM, yMM, scale = 1) {
            const centerX = A4_CONFIG.centerX * scale;
            const centerY = A4_CONFIG.centerY * scale;
            const x = centerX + xMM * A4_CONFIG.pixelsPerMM * scale;
            const y = centerY - yMM * A4_CONFIG.pixelsPerMM * scale;
            return { x: Math.round(x), y: Math.round(y) };
        }

        // å…¨å±€å˜é‡
        let uploadedImages = [];
        let selectedIndex = -1;  // å½“å‰é€‰ä¸­çš„å›¾ç‰‡ç´¢å¼•ï¼Œ-1è¡¨ç¤ºæœªé€‰ä¸­

        // DOMå…ƒç´ 
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const uploadCount = document.getElementById('uploadCount');
        const previewCount = document.getElementById('previewCount');
        const clearBtn = document.getElementById('clearBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const a4PreviewContainer = document.getElementById('a4PreviewContainer');
        const previewCanvas = document.getElementById('previewCanvas');
        const controlsOverlay = document.getElementById('controlsOverlay');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const outputCanvas = document.getElementById('outputCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        const outputCtx = outputCanvas.getContext('2d');

        // äº‹ä»¶ç›‘å¬
        uploadSection.addEventListener('click', () => fileInput.click());

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        clearBtn.addEventListener('click', clearImages);
        downloadBtn.addEventListener('click', downloadImage);

        // Canvasç‚¹å‡»äº‹ä»¶ - é€‰æ‹©å›¾ç‰‡
        previewCanvas.addEventListener('click', handleCanvasClick);

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFiles(files) {
            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

            if (imageFiles.length === 0) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            const remainingSlots = 11 - uploadedImages.length;
            const filesToLoad = imageFiles.slice(0, remainingSlots);

            let loadedCount = 0;

            filesToLoad.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImages.push({
                            file: file,
                            element: img,
                            src: e.target.result,
                            scale: 1.0,
                            offsetX: 0,
                            offsetY: 0
                        });
                        loadedCount++;

                        uploadCount.textContent = uploadedImages.length;
                        previewCount.textContent = uploadedImages.length;

                        if (uploadedImages.length === 11) {
                            downloadBtn.disabled = false;
                        }

                        renderPreview();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // æ¸²æŸ“é¢„è§ˆ
        function renderPreview() {
            const previewWidth = Math.round(A4_CONFIG.width * PREVIEW_SCALE);
            const previewHeight = Math.round(A4_CONFIG.height * PREVIEW_SCALE);

            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;

            // å¡«å……ç™½è‰²èƒŒæ™¯
            previewCtx.fillStyle = '#FFFFFF';
            previewCtx.fillRect(0, 0, previewWidth, previewHeight);

            // ç»˜åˆ¶æ‰€æœ‰å·²ä¸Šä¼ çš„å›¾ç‰‡
            uploadedImages.forEach((imgData, index) => {
                const pos = mmToPixels(POSITIONS_MM[index].x, POSITIONS_MM[index].y, PREVIEW_SCALE);
                const radius = Math.round(IMAGE_CONFIG.radius * PREVIEW_SCALE);

                // åº”ç”¨åç§»é‡ï¼ˆåœ†å½¢åŒºåŸŸä¹Ÿè·Ÿéšç§»åŠ¨ï¼‰
                const offsetX = imgData.offsetX * PREVIEW_SCALE;
                const offsetY = imgData.offsetY * PREVIEW_SCALE;
                const circleX = pos.x + offsetX;
                const circleY = pos.y + offsetY;

                // ç»˜åˆ¶åœ†å½¢èƒŒæ™¯ï¼ˆç§»åŠ¨åçš„ä½ç½®ï¼‰
                previewCtx.beginPath();
                previewCtx.arc(circleX, circleY, radius, 0, Math.PI * 2);
                previewCtx.fillStyle = '#f0f0f0';
                previewCtx.fill();
                previewCtx.strokeStyle = '#ddd';
                previewCtx.lineWidth = 1;
                previewCtx.stroke();

                // ç»˜åˆ¶å›¾ç‰‡ï¼ˆåœ†å½¢è£å‰ªï¼‰
                previewCtx.save();
                previewCtx.beginPath();
                previewCtx.arc(circleX, circleY, radius, 0, Math.PI * 2);
                previewCtx.clip();

                const img = imgData.element;
                const imgSize = Math.max(img.width, img.height);
                const baseScale = (radius * 2.5) / imgSize;
                const finalScale = baseScale * imgData.scale;
                const scaledWidth = img.width * finalScale;
                const scaledHeight = img.height * finalScale;
                const x = circleX - scaledWidth / 2;
                const y = circleY - scaledHeight / 2;

                previewCtx.drawImage(img, x, y, scaledWidth, scaledHeight);
                previewCtx.restore();
            });

            // ç»˜åˆ¶åœ†å½¢è¾¹æ¡†
            POSITIONS_MM.forEach((posMM, index) => {
                const imgData = uploadedImages[index];
                if (!imgData) {
                    // æ²¡æœ‰å›¾ç‰‡çš„ä½ç½®ï¼Œåªç»˜åˆ¶åŸºç¡€è½®å»“
                    const pos = mmToPixels(posMM.x, posMM.y, PREVIEW_SCALE);
                    const radius = Math.round(IMAGE_CONFIG.radius * PREVIEW_SCALE);

                    previewCtx.beginPath();
                    previewCtx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                    previewCtx.strokeStyle = '#333';
                    previewCtx.lineWidth = 1;
                    previewCtx.setLineDash([]);
                    previewCtx.stroke();
                    return;
                }

                // æœ‰å›¾ç‰‡çš„ä½ç½®ï¼Œåº”ç”¨åç§»é‡
                const offsetX = imgData.offsetX * PREVIEW_SCALE;
                const offsetY = imgData.offsetY * PREVIEW_SCALE;
                const pos = mmToPixels(posMM.x, posMM.y, PREVIEW_SCALE);
                const radius = Math.round(IMAGE_CONFIG.radius * PREVIEW_SCALE);
                const isSelected = selectedIndex === index;

                const circleX = pos.x + offsetX;
                const circleY = pos.y + offsetY;

                // å¦‚æœé€‰ä¸­ï¼Œç»˜åˆ¶é«˜äº®è¾¹æ¡†ï¼ˆä½¿ç”¨ç§»åŠ¨åçš„åœ†å¿ƒï¼‰
                if (isSelected) {
                    previewCtx.beginPath();
                    previewCtx.arc(circleX, circleY, radius + 4, 0, Math.PI * 2);
                    previewCtx.strokeStyle = '#667eea';
                    previewCtx.lineWidth = 3;
                    previewCtx.setLineDash([]);
                    previewCtx.stroke();
                }

                // ç»˜åˆ¶æ·±è‰²å¤–è½®å»“çº¿ï¼ˆæœ€ç»†ï¼‰
                previewCtx.beginPath();
                previewCtx.arc(circleX, circleY, radius, 0, Math.PI * 2);
                previewCtx.strokeStyle = '#333';
                previewCtx.lineWidth = 1;
                previewCtx.setLineDash([]);
                previewCtx.stroke();
            });

            // æ›´æ–°æ§åˆ¶æŒ‰é’®
            updateControls();

            // æ˜¾ç¤ºé¢„è§ˆ
            a4PreviewContainer.classList.add('show');
        }

        // æ›´æ–°æ§åˆ¶æŒ‰é’®
        function updateControls() {
            controlsOverlay.innerHTML = '';

            const previewWidth = previewCanvas.width;
            const previewHeight = previewCanvas.height;

            // æ›´æ–°overlayå°ºå¯¸
            controlsOverlay.style.width = previewWidth + 'px';
            controlsOverlay.style.height = previewHeight + 'px';

            POSITIONS_MM.forEach((posMM, index) => {
                const pos = mmToPixels(posMM.x, posMM.y, PREVIEW_SCALE);
                const radius = Math.round(IMAGE_CONFIG.radius * PREVIEW_SCALE);

                // åº”ç”¨è¯¥å›¾ç‰‡çš„åç§»é‡ï¼ˆæ§åˆ¶æŒ‰é’®è·Ÿéšå›¾ç‰‡ç§»åŠ¨ï¼‰
                const imgData = uploadedImages[index];
                const offsetX = imgData ? imgData.offsetX * PREVIEW_SCALE : 0;
                const offsetY = imgData ? imgData.offsetY * PREVIEW_SCALE : 0;
                const controlX = pos.x + offsetX;
                const controlY = pos.y + offsetY;

                // åˆ›å»ºæ§åˆ¶ç»„
                const controlGroup = document.createElement('div');
                controlGroup.className = 'control-group';
                controlGroup.style.left = controlX + 'px';
                controlGroup.style.top = controlY + 'px';

                const hasImage = imgData !== undefined;
                const isSelected = selectedIndex === index;
                const scaleValue = hasImage ? (imgData.scale * 100).toFixed(0) + '%' : '-';

                // åªæ˜¾ç¤ºç¼©æ”¾å€¼ï¼Œä¸æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                controlGroup.innerHTML = `
                    <div class="scale-badge">${scaleValue}</div>
                    ${isSelected && hasImage ? `
                    <div class="control-buttons">
                        <div class="control-row">
                            <button class="control-btn direction-btn" data-index="${index}" data-action="move-up" title="ä¸Šç§»">â†‘</button>
                        </div>
                        <div class="control-row center-row">
                            <button class="control-btn direction-btn" data-index="${index}" data-action="move-left" title="å·¦ç§»">â†</button>
                            <button class="control-btn" data-index="${index}" data-action="zoom-out" title="ç¼©å°">-</button>
                            <button class="control-btn reset-btn" data-index="${index}" data-action="reset" title="å¤åŸ">å¤åŸ</button>
                            <button class="control-btn" data-index="${index}" data-action="zoom-in" title="æ”¾å¤§">+</button>
                            <button class="control-btn direction-btn" data-index="${index}" data-action="move-right" title="å³ç§»">â†’</button>
                        </div>
                        <div class="control-row">
                            <button class="control-btn direction-btn" data-index="${index}" data-action="move-down" title="ä¸‹ç§»">â†“</button>
                        </div>
                        <div class="control-row"><button class="control-btn delete-btn" data-index="${index}" data-action="delete" title="åˆ é™¤">ğŸ—‘</button></div>
                    </div>
                    ` : ''}
                `;

                controlsOverlay.appendChild(controlGroup);
            });

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', handleControl);
            });
        }

        // å¤„ç†Canvasç‚¹å‡» - é€‰æ‹©å›¾ç‰‡
        function handleCanvasClick(e) {
            const rect = previewCanvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æŸä¸ªåœ†å½¢å†…ï¼ˆè€ƒè™‘å›¾ç‰‡åç§»ï¼‰
            let foundIndex = -1;
            POSITIONS_MM.forEach((posMM, index) => {
                // è·³è¿‡æ²¡æœ‰å›¾ç‰‡çš„ä½ç½®
                if (!uploadedImages[index]) {
                    return;
                }

                const pos = mmToPixels(posMM.x, posMM.y, PREVIEW_SCALE);
                const radius = Math.round(IMAGE_CONFIG.radius * PREVIEW_SCALE);

                // åº”ç”¨è¯¥å›¾ç‰‡çš„åç§»é‡
                const offsetX = uploadedImages[index].offsetX * PREVIEW_SCALE;
                const offsetY = uploadedImages[index].offsetY * PREVIEW_SCALE;
                const circleX = pos.x + offsetX;
                const circleY = pos.y + offsetY;

                const dx = clickX - circleX;
                const dy = clickY - circleY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance <= radius) {
                    foundIndex = index;
                }
            });

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            if (foundIndex !== selectedIndex) {
                selectedIndex = foundIndex;
                renderPreview();
            }
        }

        // å¤„ç†æ‰€æœ‰æ§åˆ¶æ“ä½œ
        function handleControl(e) {
            e.stopPropagation();
            const btn = e.target;
            const index = parseInt(btn.dataset.index);
            const action = btn.dataset.action;

            // åˆ é™¤æ“ä½œ
            if (action === 'delete') {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                    uploadedImages.splice(index, 1);
                    uploadCount.textContent = uploadedImages.length;
                    previewCount.textContent = uploadedImages.length;
                    downloadBtn.disabled = uploadedImages.length !== 11;
                    selectedIndex = -1;  // åˆ é™¤åå–æ¶ˆé€‰ä¸­
                    renderPreview();
                }
                return;
            }

            // å…¶ä»–æ“ä½œéœ€è¦å…ˆä¸Šä¼ å›¾ç‰‡
            if (!uploadedImages[index]) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            const imgData = uploadedImages[index];
            const zoomStep = 0.1;
            const moveStep = 10;  // æ¯æ¬¡ç§»åŠ¨10åƒç´ 

            if (action === 'zoom-in') {
                imgData.scale = Math.min(imgData.scale + zoomStep, 3.0);
            } else if (action === 'zoom-out') {
                imgData.scale = Math.max(imgData.scale - zoomStep, 0.3);
            } else if (action === 'reset') {
                imgData.scale = 1.0;
                imgData.offsetX = 0;
                imgData.offsetY = 0;
            } else if (action === 'move-up') {
                imgData.offsetY += moveStep;
            } else if (action === 'move-down') {
                imgData.offsetY -= moveStep;
            } else if (action === 'move-left') {
                imgData.offsetX -= moveStep;
            } else if (action === 'move-right') {
                imgData.offsetX += moveStep;
            }

            // é‡æ–°æ¸²æŸ“é¢„è§ˆ
            renderPreview();
        }

        // æ¸…ç©ºå›¾ç‰‡
        function clearImages() {
            uploadedImages = [];
            selectedIndex = -1;  // æ¸…ç©ºæ—¶å–æ¶ˆé€‰ä¸­
            uploadCount.textContent = '0';
            previewCount.textContent = '0';
            downloadBtn.disabled = true;
            a4PreviewContainer.classList.remove('show');
            fileInput.value = '';
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }

        // ç”Ÿæˆé«˜åˆ†è¾¨ç‡è¾“å‡ºå›¾åƒ
        function generateOutputImage() {
            outputCanvas.width = A4_CONFIG.width;
            outputCanvas.height = A4_CONFIG.height;

            // å¡«å……ç™½è‰²èƒŒæ™¯
            outputCtx.fillStyle = '#FFFFFF';
            outputCtx.fillRect(0, 0, A4_CONFIG.width, A4_CONFIG.height);

            // ç»˜åˆ¶æ‰€æœ‰å›¾ç‰‡
            uploadedImages.forEach((imgData, index) => {
                const pos = mmToPixels(POSITIONS_MM[index].x, POSITIONS_MM[index].y, 1);
                const radius = IMAGE_CONFIG.radius;

                // åº”ç”¨è¯¥å›¾ç‰‡çš„åç§»é‡ï¼ˆåœ†å½¢åŒºåŸŸä¹Ÿè·Ÿéšç§»åŠ¨ï¼‰
                const offsetX = imgData.offsetX;
                const offsetY = imgData.offsetY;
                const circleX = pos.x + offsetX;
                const circleY = pos.y + offsetY;

                // åˆ›å»ºåœ†å½¢è£å‰ª
                outputCtx.save();
                outputCtx.beginPath();
                outputCtx.arc(circleX, circleY, radius, 0, Math.PI * 2);
                outputCtx.clip();

                const img = imgData.element;
                const imgSize = Math.max(img.width, img.height);
                const baseScale = (radius * 2.5) / imgSize;
                const finalScale = baseScale * imgData.scale;
                const scaledWidth = img.width * finalScale;
                const scaledHeight = img.height * finalScale;
                const x = circleX - scaledWidth / 2;
                const y = circleY - scaledHeight / 2;

                outputCtx.drawImage(img, x, y, scaledWidth, scaledHeight);
                outputCtx.restore();
            });

            // ç»˜åˆ¶æ‰€æœ‰åœ†å½¢çš„æ·±è‰²è½®å»“çº¿
            POSITIONS_MM.forEach((posMM, index) => {
                const imgData = uploadedImages[index];
                const pos = mmToPixels(posMM.x, posMM.y, 1);
                const radius = IMAGE_CONFIG.radius;

                // åº”ç”¨åç§»é‡
                const offsetX = imgData ? imgData.offsetX : 0;
                const offsetY = imgData ? imgData.offsetY : 0;
                const circleX = pos.x + offsetX;
                const circleY = pos.y + offsetY;

                outputCtx.beginPath();
                outputCtx.arc(circleX, circleY, radius, 0, Math.PI * 2);
                outputCtx.strokeStyle = '#333';
                outputCtx.lineWidth = 1;
                outputCtx.setLineDash([]);
                outputCtx.stroke();
            });

            return outputCanvas.toDataURL('image/png');
        }

        // ä¸‹è½½å›¾åƒ
        function downloadImage() {
            if (uploadedImages.length !== 11) {
                alert('è¯·ä¸Šä¼ 11å¼ å›¾ç‰‡åå†ä¸‹è½½ï¼');
                return;
            }

            const dataURL = generateOutputImage();
            const link = document.createElement('a');
            link.download = 'A4åˆæˆå›¾åƒ_' + new Date().getTime() + '.png';
            link.href = dataURL;
            link.click();
        }

        // æ‰“å°é…ç½®ä¿¡æ¯
        console.log('A4é…ç½®:', A4_CONFIG);
        console.log('å›¾åƒé…ç½®:', IMAGE_CONFIG);
    </script>
</body>
</html>
